    <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recharge via M-PESA - CYPX ONLINE CRYPTO</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Firebase (compat for simplicity in one file) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>

  <style>
    :root {
      --bg: #001a33;
      --bg2: #07284a;
      --brand: #34B233;      /* M-PESA green */
      --accent: #ffcc00;     /* gold accent */
      --text: #ffffff;
      --muted: #a7bdd8;
      --card: #0b2f5a;
      --card-2: #0e3a6f;
      --danger: #ff4d4f;
      --ok: #22c55e;
      --border: #1e477a;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background: linear-gradient(180deg, var(--bg) 0%, #001f3f 100%); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    a { color: inherit; text-decoration: none; }

    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(6px);
      background: rgba(0, 31, 63, 0.8);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      padding: 14px 18px; font-weight: 700; letter-spacing: 0.3px;
      box-shadow: var(--shadow);
    }
    header img { height: 28px; width: 28px; object-fit: contain; border-radius: 6px; }
    header .title { font-size: 18px; opacity: 0.95; }

    .container { width: min(100%, 960px); margin: 24px auto 120px; padding: 0 16px; }

    .hero {
      background: radial-gradient(1200px 500px at 50% -10%, #123e74 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg2), transparent);
      border: 1px solid var(--border);
      padding: 18px; border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .hero h1 { margin: 0 0 8px; font-size: 20px; }
    .hero p { margin: 0; color: var(--muted); font-size: 14px; }

    .grid {
      display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.3fr 1fr; }
    }

    .card {
      background: linear-gradient(160deg, var(--card) 0%, var(--card-2) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h2 { margin: 0 0 10px; font-size: 18px; }
    .subtle { color: var(--muted); font-size: 13px; }

    .field { margin: 12px 0; }
    .label { font-size: 13px; color: #cfe3ff; margin-bottom: 6px; display: block; }
    .input, .textarea, .file {
      width: 100%; padding: 12px 12px;
      border-radius: 12px; border: 1px solid var(--border);
      background: #0a264a; color: var(--text); outline: none;
      transition: border-color .2s, box-shadow .2s, transform .02s ease;
    }
    .input:focus, .textarea:focus, .file:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.15); }
    .textarea { min-height: 80px; resize: vertical; }
    .file { padding: 10px; background: #0a2a52; }

    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 620px) {
      .row.two { grid-template-columns: 1fr 1fr; }
      .row.thirds { grid-template-columns: 2fr 1fr; }
    }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
      padding: 12px 14px; border-radius: 12px; border: 1px solid #2b5e2e;
      font-weight: 700; letter-spacing: .2px; cursor: pointer; user-select: none;
      background: linear-gradient(180deg, #2bbf59, var(--brand));
      color: #062b0c; transition: transform .04s ease, filter .15s ease;
      width: 100%;
    }
    .btn:hover { filter: brightness(1.03); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: linear-gradient(180deg, #184a88, #113b6f); color: #dfeeff; border-color: var(--border);
    }
    .btn.icon { width: auto; padding: 10px 12px; border-radius: 10px; }
    .muted-line { font-size: 12px; color: var(--muted); margin-top: 6px; }

    .mpesa-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: #0a2f13; border: 1px solid #2b5e2e; padding: 8px 10px; border-radius: 12px; font-weight: 700;
    }
    .copy {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px;
      border-radius: 10px; background: #08335e; border: 1px dashed var(--border);
      cursor: pointer; font-size: 13px;
    }

    .list { margin: 10px 0 0; padding: 0 0 0 18px; color: #cfe3ff; }
    .list li { margin: 6px 0; }

    .history {
      display: grid; gap: 10px; margin-top: 8px; max-height: 420px; overflow: auto; padding-right: 4px;
    }
    .history .item {
      border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; background: #0a264a;
      display: grid; gap: 6px;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border);
    }
    .badge.ok { background: #0b3a1a; color: #caffd3; border-color: #226d3c; }
    .badge.pending { background: #3d320b; color: #ffe7a3; border-color: #7c6922; }
    .badge.rejected { background: #3a0b0b; color: #ffcaca; border-color: #7c2222; }

    nav {
      position: fixed; bottom: 0; left: 0; right: 0; background-color: #002244;
      display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--border);
    }
    nav a { color: white; text-align: center; text-decoration: none; font-size: 12px; opacity: 0.9; }
    nav i { font-size: 18px; display: block; margin-bottom: 4px; }

    .toast {
      position: fixed; top: 18px; right: 18px; background: #072d12; color: #d8ffe6; border: 1px solid #1f6b3a;
      padding: 12px 14px; border-radius: 12px; box-shadow: var(--shadow); display: none; z-index: 9999; font-weight: 600;
    }
    .toast.error { background:#3a1111; color:#ffd7d7; border-color:#8a2a2a; }
  </style>
</head>
<body>
  <header>
    <img src="https://png.pngtree.com/png-clipart/20221216/original/pngtree-vip-icon-design-png-image_8749175.png" alt="logo"/>
    <div class="title">Recharge via M-PESA</div>
  </header>

  <div class="container">
    <div class="hero">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap;">
        <div class="mpesa-badge">
          <i class="fa-solid fa-mobile-screen-button"></i> M-PESA (Kenya)
        </div>
        <div style="display:flex; gap:8px; flex-wrap: wrap;">
          <button class="copy" data-copy="247247"><i class="fa-regular fa-copy"></i> Paybill: <strong>247247</strong></button>
          <button class="copy" data-copy="CYPXONLINE"><i class="fa-regular fa-copy"></i> Account: <strong>CYPXONLINE</strong></button>
        </div>
      </div>
      <p class="subtle" style="margin-top:10px;">Lipa na M-PESA &rarr; Paybill <strong>247247</strong>, Account <strong>CYPXONLINE</strong>. Then submit the form below with your M-PESA code.</p>
    </div>

    <div class="grid">
      <!-- LEFT: FORM -->
      <div class="card">
        <h2><i class="fa-solid fa-coins"></i> Submit Recharge</h2>
        <p class="subtle">Fill in the details exactly as they appear on your M-PESA receipt. You’ll see it in your history instantly.</p>

        <form id="rechargeForm">
          <div class="row two">
            <div class="field">
              <label class="label" for="amount">Amount (KES)</label>
              <input id="amount" class="input" type="number" inputmode="decimal" min="1" step="1" placeholder="e.g. 500" required/>
              <div class="muted-line">Minimum 1 KES.</div>
            </div>
            <div class="field">
              <label class="label" for="phone">M-PESA Phone</label>
              <input id="phone" class="input" type="tel" placeholder="e.g. 07XXXXXXXX / 01XXXXXXXX" required/>
              <div class="muted-line">Use the number that sent the payment.</div>
            </div>
          </div>

          <div class="row thirds">
            <div class="field">
              <label class="label" for="code">M-PESA Code</label>
              <input id="code" class="input" type="text" placeholder="e.g. QLN3XYZ0AB" required/>
              <div class="muted-line">Usually 10–12 alphanumeric characters.</div>
            </div>
            <div class="field">
              <label class="label" for="date">Payment Date/Time</label>
              <input id="date" class="input" type="datetime-local"/>
              <div class="muted-line">Optional (auto-fills if empty).</div>
            </div>
          </div>

          <div class="field">
            <label class="label" for="note">Note (optional)</label>
            <textarea id="note" class="textarea" placeholder="Anything we should know?"></textarea>
          </div>

          <div class="field">
            <label class="label" for="receipt">Receipt / Screenshot (optional)</label>
            <input id="receipt" class="file" type="file" accept="image/*"/>
            <div class="muted-line">PNG/JPG under 5 MB.</div>
          </div>

          <div class="row two" style="margin-top: 6px;">
            <button type="submit" class="btn"><i class="fa-solid fa-paper-plane"></i> Submit Recharge</button>
            <button type="button" id="resetBtn" class="btn secondary"><i class="fa-solid fa-rotate-left"></i> Reset</button>
          </div>
          <div class="muted-line" style="margin-top:10px;">
            By submitting, you agree this is a genuine M-PESA payment. False or incorrect info may delay processing.
          </div>
        </form>
      </div>

      <!-- RIGHT: INSTRUCTIONS + HISTORY -->
      <div class="card">
        <h2><i class="fa-solid fa-list-check"></i> How to Pay</h2>
        <ol class="list">
          <li>Open <strong>M-PESA</strong> &rarr; <strong>Lipa na M-PESA</strong> &rarr; <strong>Paybill</strong>.</li>
          <li>Enter <strong>Business No:</strong> <code>247247</code>.</li>
          <li>Enter <strong>Account:</strong> <code>CYPXONLINE</code>.</li>
          <li>Enter <strong>Amount</strong> you want to recharge and complete payment.</li>
          <li>Copy the <strong>M-PESA code</strong> from the SMS and submit it here.</li>
        </ol>

        <div style="height:12px;"></div>
        <h2 style="margin-top: 6px;"><i class="fa-solid fa-clock-rotate-left"></i> Your Recent Submissions</h2>
        <div id="history" class="history">
          <div class="subtle">No submissions yet.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i>Home</a>
    <a href="task.html"><i class="fas fa-tasks"></i>Task</a>
    <a href="team.html"><i class="fas fa-users"></i>Team</a>
    <a href="vip.html"><i class="fas fa-crown"></i>VIP</a>
    <a href="profile.html"><i class="fas fa-user"></i>Me</a>
  </nav>

  <!-- Toasts -->
  <div id="toast" class="toast"></div>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyCCW4G9JlVu_xb0bGjlKmsi5mdqXSwvFak",
      authDomain: "quantum-rio.firebaseapp.com",
      databaseURL: "https://quantum-rio-default-rtdb.firebaseio.com",
      projectId: "quantum-rio",
      storageBucket: "quantum-rio.firebasestorage.app",
      messagingSenderId: "805433999377",
      appId: "1:805433999377:web:d0efa8c46ec4a0fa30f1b0",
      measurementId: "G-4RSQXZJX44"
    };

    // ===== Init =====
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ===== Utils =====
    const toastEl = document.getElementById('toast');
    function showToast(msg, type = 'ok', timeout = 3000) {
      toastEl.textContent = msg;
      toastEl.className = 'toast' + (type === 'error' ? ' error' : '');
      toastEl.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = 'none', timeout);
    }

    function kEPhoneNormalize(p) {
      // Accept 07xxxxxxxx / 01xxxxxxxx / 2547xxxxxxxx / +2547xxxxxxxx
      let x = (p || '').toString().trim().replace(/\s+/g, '');
      if (x.startsWith('+')) x = x.slice(1);
      if (x.startsWith('254') && x.length === 12) return '+' + x;      // +2547XXXXXXXX
      if (x.startsWith('0') && x.length === 10) return '+254' + x.slice(1);
      if (x.startsWith('1') && x.length === 10) return '+254' + x;     // rarely used, but support 1xxxxxxxx?
      return x.startsWith('+254') ? x : x; // fallback, validation will catch
    }

    function isValidKEPhone(p) {
      const n = kEPhoneNormalize(p);
      return /^\+254(7|1)\d{8}$/.test(n);
    }

    function isValidMpesaCode(code) {
      // M-PESA codes: typically 10-12 uppercase alphanumerics, never ambiguous chars like O/0 are possible though.
      return /^[A-Z0-9]{10,12}$/i.test((code||'').trim());
    }

    function formatKES(v) {
      try {
        return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES', maximumFractionDigits: 0 }).format(v);
      } catch (_) { return 'KES ' + v; }
    }

    // ===== Auth Gate =====
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "landing.html";
        return;
      }
      // Load history for this user
      loadHistory(user.uid);
    });

    // ===== Copy buttons =====
    document.querySelectorAll('.copy').forEach(btn => {
      btn.addEventListener('click', async () => {
        const val = btn.getAttribute('data-copy');
        try {
          await navigator.clipboard.writeText(val);
          showToast('Copied: ' + val);
        } catch (e) {
          showToast('Could not copy. Long-press to copy.', 'error', 4000);
        }
      });
    });

    // ===== Form Handling =====
    const form = document.getElementById('rechargeForm');
    const resetBtn = document.getElementById('resetBtn');

    resetBtn.addEventListener('click', () => {
      form.reset();
      showToast('Form cleared');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return showToast('You must be signed in.', 'error');

      const amount = parseInt(document.getElementById('amount').value, 10);
      const phoneRaw = document.getElementById('phone').value;
      const code = (document.getElementById('code').value || '').trim().toUpperCase();
      const dateInput = document.getElementById('date').value;
      const note = document.getElementById('note').value || '';
      const file = document.getElementById('receipt').files[0] || null;

      // Client-side validations
      if (!(amount > 0)) return showToast('Please enter a valid amount (KES).', 'error');
      if (!isValidKEPhone(phoneRaw)) return showToast('Enter a valid Kenyan phone number.', 'error');
      if (!isValidMpesaCode(code)) return showToast('Enter a valid M-PESA code (10–12 letters/numbers).', 'error');

      const phone = kEPhoneNormalize(phoneRaw);
      const paidAt = dateInput ? new Date(dateInput).toISOString() : new Date().toISOString();

      // Prepare doc
      const ref = db.collection('recharges').doc(); // random id
      const docData = {
        uid: user.uid,
        amount,
        phone,
        code,
        note,
        status: 'pending', // to be updated by admin / backend
        paidAt,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        receiptUrl: null,
        source: 'mpesa',
        paybill: '247247',
        account: 'CYPXONLINE'
      };

      // Upload receipt if provided
      let receiptUrl = null;
      try {
        if (file) {
          if (file.size > 5 * 1024 * 1024) return showToast('Image too large (max 5 MB).', 'error');
          const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
          const path = `receipts/${user.uid}/${ref.id}.${ext}`;
          const task = await storage.ref(path).put(file);
          receiptUrl = await task.ref.getDownloadURL();
          docData.receiptUrl = receiptUrl;
        }
      } catch (err) {
        console.error(err);
        return showToast('Upload failed. Try again.', 'error');
      }

      try {
        await ref.set(docData);
        form.reset();
        showToast('Recharge submitted successfully!');
      } catch (err) {
        console.error(err);
        showToast('Could not save. Please try again.', 'error');
      }
    });

    // ===== History (Realtime) =====
    function loadHistory(uid) {
      const container = document.getElementById('history');
      // Clear
      container.innerHTML = '<div class="subtle">Loading…</div>';

      db.collection('recharges')
        .where('uid', '==', uid)
        .orderBy('createdAt', 'desc')
        .limit(20)
        .onSnapshot((snap) => {
          if (snap.empty) {
            container.innerHTML = '<div class="subtle">No submissions yet.</div>';
            return;
          }
          container.innerHTML = '';
          snap.forEach((doc) => {
            const d = doc.data();
            const badgeClass = d.status === 'approved' ? 'ok' : (d.status === 'rejected' ? 'rejected' : 'pending');
            const amount = formatKES(d.amount || 0);
            const time = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.paidAt || Date.now());
            const timeStr = time.toLocaleString();

            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                  <span class="badge ${badgeClass}"><i class="fa-solid fa-circle-dot"></i> ${d.status || 'pending'}</span>
                  <strong>${amount}</strong>
                </div>
                <div class="subtle">${timeStr}</div>
              </div>
              <div class="subtle">Code: <code>${(d.code || '').toUpperCase()}</code> • Phone: ${d.phone || ''}</div>
              <div class="subtle">Paybill: <code>${d.paybill || ''}</code> • Account: <code>${d.account || ''}</code> • Source: ${d.source || 'mpesa'}</div>
              ${d.note ? `<div class="subtle">Note: ${d.note}</div>` : ''}
              ${d.receiptUrl ? `<div><a class="copy" style="display:inline-flex; margin-top:6px;" href="${d.receiptUrl}" target="_blank" rel="noopener"><i class="fa-regular fa-image"></i> View Receipt</a></div>` : ''}
            `;
            container.appendChild(item);
          });
        }, (err) => {
          console.error(err);
          container.innerHTML = '<div class="subtle">Failed to load history.</div>';
        });
    }
  </script>
</body>
</html>
