<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Withdraw via M-Pesa - CYPX ONLINE CRYPTO</title>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root{
  --bg:#001a33; --card:#0b2f5a; --accent:#25d366; --text:#fff; --radius:14px; --shadow:0 8px 30px rgba(0,0,0,0.25);
}
html, body{
  margin:0; padding:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,var(--bg),#001f3f);
  color:var(--text); height:100%; width:100%;
}
body{
  display:flex; justify-content:center; align-items:flex-start; padding:16px 0 80px 0;
}
header{
  position:fixed; top:0; width:100%; text-align:center;
  padding:14px 0; font-weight:700;
  background:rgba(0,0,0,0.35); border-bottom:1px solid rgba(255,255,255,0.03); z-index:10;
}
.container{width:100%; max-width:420px; margin-top:60px;}
.card{
  background:linear-gradient(160deg,var(--card),#0e3a6f);
  padding:25px 20px; border-radius:var(--radius); box-shadow:var(--shadow);
  width:100%; max-height:calc(100vh - 140px); overflow-y:auto; box-sizing:border-box;
  margin:auto;
}
h2{margin:0 0 12px; font-size:18px; color:#bfffd0; text-align:center;}
.label{display:block; margin:8px 0 6px; color:#cfe3ff; font-size:13px;}
.input{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:#06243f; color:var(--text); font-size:15px; margin-bottom:10px;}
.btn{width:100%; margin-top:14px; padding:12px; border-radius:12px; border:0; font-weight:700; font-size:15px; cursor:pointer; background:linear-gradient(180deg,#2ecc71,var(--accent)); color:white;}
.small{font-size:13px; color:#d8ecff; margin-top:8px; text-align:center;}
#balanceBox{display:inline-block; background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px; font-weight:700; margin-bottom:10px;}
.popup{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); min-width:220px; padding:14px 18px; border-radius:12px; z-index:999; display:none; text-align:center; font-weight:700;}
.popup.success{background:#083b18;color:#d6ffd6;}
.popup.error{background:#3a1111;color:#ffd7d7;}

nav{
  position:fixed; bottom:0; left:0; right:0; background:#002244;
  display:flex; justify-content:space-around; height:60px; align-items:center;
}
nav a{flex:1; color:white; text-decoration:none; font-size:12px; text-align:center;}
nav i{display:block; margin-bottom:4px; font-size:18px;}
</style>
</head>
<body>
<header>Withdraw via M-Pesa</header>

<div class="container">
  <div class="card">
    <h2><i class="fa-solid fa-money-bill-transfer"></i> Request Withdrawal</h2>
    <div style="text-align:center; margin-bottom:10px;">
      <div style="font-size:12px;color:#cfe3ff">Available balance</div>
      <div id="balanceBox">KES <span id="balance">—</span></div>
    </div>

    <form id="withdrawForm">
      <label class="label" for="phone">M-Pesa Number</label>
      <input id="phone" class="input" type="text" placeholder="e.g. 07XXXXXXXX" maxlength="10" required />

      <label class="label" for="amount">Withdrawal Amount (KES)</label>
      <input id="amount" class="input" type="number" min="1000" placeholder="e.g. 2000" required />
      <div class="small">Minimum withdrawal <strong>1,000 KES</strong>.</div>
      <button id="submitBtn" class="btn" type="submit">Submit Withdrawal</button>
    </form>
  </div>
</div>

<nav>
  <a href="dashboard.html"><i class="fas fa-home"></i><br>Home</a>
  <a href="task.html"><i class="fas fa-tasks"></i><br>Task</a>
  <a href="team.html"><i class="fas fa-users"></i><br>Team</a>
  <a href="vip.html"><i class="fas fa-crown"></i><br>VIP</a>
  <a href="profile.html"><i class="fas fa-user"></i><br>Me</a>
</nav>

<div id="popup" class="popup"></div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyCCW4G9JlVu_xb0bGjlKmsi5mdqXSwvFak",
  authDomain:"quantum-rio.firebaseapp.com",
  databaseURL:"https://quantum-rio-default-rtdb.firebaseio.com",
  projectId:"quantum-rio",
  storageBucket:"quantum-rio.appspot.com",
  messagingSenderId:"805433999377",
  appId:"1:805433999377:web:d0efa8c46ec4a0fa30f1b0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const balanceEl = document.getElementById('balance');
const phoneInput = document.getElementById('phone');
const amountInput = document.getElementById('amount');
const submitBtn = document.getElementById('submitBtn');
const form = document.getElementById('withdrawForm');
const popup = document.getElementById('popup');

function showPopup(msg,type='success',timeout=2600){
  popup.textContent = msg;
  popup.className='popup '+(type==='error'?'error':'success');
  popup.style.display='block';
  setTimeout(()=>popup.style.display='none',timeout);
}

function isValidMPesa(phone){ return /^07\d{8}$/.test(phone); }

let currentUser=null;

auth.onAuthStateChanged(async user=>{
  currentUser=user;
  if(user){
    submitBtn.disabled=false;

    // Auto-fill phone used to register
    const snap=await db.ref(`users/${user.uid}/phone`).once('value');
    const phoneVal=snap.val();
    if(phoneVal && isValidMPesa(phoneVal)){ phoneInput.value=phoneVal; }

    // Real-time balance
    db.ref(`users/${user.uid}/balance`).on('value',s=>{
      balanceEl.textContent=(Number(s.val())||0).toLocaleString('en-US');
    });
  } else {
    balanceEl.textContent='—';
    submitBtn.disabled=true;
  }
});

form.addEventListener('submit',async e=>{
  e.preventDefault();
  if(!currentUser){ showPopup('Login required','error'); return; }

  const phone = phoneInput.value.trim();
  const amount = Math.floor(Number(amountInput.value));
  if(!isValidMPesa(phone)){ showPopup('Enter valid M-Pesa number','error'); return; }
  if(!amount || amount < 1000){ showPopup('Minimum withdrawal is 1,000 KES','error'); return; }

  submitBtn.disabled=true;
  submitBtn.textContent='Processing...';

  // Transaction
  const balanceRef = db.ref(`users/${currentUser.uid}/balance`);
  balanceRef.transaction(bal=>{
    bal = Number(bal)||0;
    if(bal>=amount){ return bal-amount; }
    return; // abort if insufficient
  }, async (err, committed, snap)=>{
    submitBtn.disabled=false;
    submitBtn.textContent='Submit Withdrawal';
    if(err){ showPopup('Error processing','error'); return; }
    if(!committed){ showPopup('Insufficient balance','error'); return; }

    try {
      await db.ref(`withdrawals/${currentUser.uid}`).push({
        amount: amount,
        status: 'submitted',
        timestamp: Date.now(),
        phone: phone
      });
      amountInput.value='';
      showPopup(`Withdrawal request submitted. KES ${amount.toLocaleString()} deducted.`,'success');
    } catch(err){
      showPopup('Withdrawal deducted but not logged','error');
    }
  });
});
</script>
</body>
</html>
