<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Withdraw via M-Pesa - CYPX ONLINE CRYPTO</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    :root{
      --bg:#001a33; --card:#0b2f5a; --accent:#25d366; --muted:#a7bdd8; --text:#fff;
      --radius:14px; --shadow: 0 8px 30px rgba(0,0,0,0.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg),#001f3f);color:var(--text);-webkit-font-smoothing:antialiased}
    header{padding:14px 18px;font-weight:700;background:rgba(0,0,0,0.35);border-bottom:1px solid rgba(255,255,255,0.03)}
    .container{width:min(100%,920px);margin:28px auto;padding:0 18px}
    .card{background:linear-gradient(160deg,var(--card),#0e3a6f);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow)}
    h2{margin:0 0 12px;font-size:18px;color:#bfffd0}
    .label{display:block;margin:8px 0 6px;color:#cfe3ff;font-size:13px}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#06243f;color:var(--text);font-size:15px}
    .row{display:flex;gap:12px;align-items:center}
    .btn{margin-top:14px;padding:12px;border-radius:12px;border:0;font-weight:700;font-size:15px;cursor:pointer;background:linear-gradient(180deg,#2ecc71,var(--accent));color:white;box-shadow:0 6px 18px rgba(0,0,0,0.35)}
    .small{font-size:13px;color:#d8ecff;margin-top:8px}
    nav{position:fixed;bottom:0;left:0;right:0;background:#002244;display:flex;justify-content:space-around;padding:10px 0;border-top:1px solid rgba(255,255,255,0.03)}
    nav a{color:white;text-decoration:none;font-size:12px;text-align:center}
    nav i{display:block;margin-bottom:4px}
    #balanceBox{display:inline-block;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;font-weight:700}
    .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.95);min-width:220px;padding:14px 18px;border-radius:12px;z-index:999;display:none;text-align:center;font-weight:700}
    .popup.success{background:#083b18;color:#d6ffd6;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .popup.error{background:#3a1111;color:#ffd7d7;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
  </style>
</head>
<body>
  <header>Withdraw via M-Pesa</header>

  <div class="container">
    <div class="card">
      <h2><i class="fa-solid fa-money-bill-transfer"></i> Request Withdrawal</h2>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div style="font-size:12px;color:#cfe3ff">Available balance</div>
          <div id="balanceBox">KES <span id="balance">—</span></div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:#cfe3ff">Logged in as</div>
          <div id="userEmail" style="font-size:13px;color:#d8ecff">—</div>
        </div>
      </div>

      <form id="withdrawForm">
        <label class="label" for="amount">Withdrawal Amount (KES)</label>
        <input id="amount" class="input" type="number" min="1000" placeholder="e.g. 2000" required />
        <div class="small">Minimum withdrawal <strong>1,000 KES</strong>. Your balance must be sufficient — amount will be deducted immediately on submit.</div>
        <button id="submitBtn" class="btn" type="submit"><i class="fa-regular fa-paper-plane"></i> Submit Withdrawal</button>
      </form>
    </div>
  </div>

  <nav>
    <a href="dashboard.html"><i class="fas fa-home"></i>Home</a>
    <a href="task.html"><i class="fas fa-tasks"></i>Task</a>
    <a href="team.html"><i class="fas fa-users"></i>Team</a>
    <a href="vip.html"><i class="fas fa-crown"></i>VIP</a>
    <a href="profile.html"><i class="fas fa-user"></i>Me</a>
  </nav>

  <div id="popup" class="popup"></div>

  <script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey:"AIzaSyCCW4G9JlVu_xb0bGjlKmsi5mdqXSwvFak",
    authDomain:"quantum-rio.firebaseapp.com",
    databaseURL:"https://quantum-rio-default-rtdb.firebaseio.com",
    projectId:"quantum-rio",
    storageBucket:"quantum-rio.appspot.com",
    messagingSenderId:"805433999377",
    appId:"1:805433999377:web:d0efa8c46ec4a0fa30f1b0",
    measurementId:"G-4RSQXZJX44"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- UI refs ----------
  const balanceEl = document.getElementById('balance');
  const userEmailEl = document.getElementById('userEmail');
  const form = document.getElementById('withdrawForm');
  const amountInput = document.getElementById('amount');
  const submitBtn = document.getElementById('submitBtn');
  const popup = document.getElementById('popup');

  function showPopup(msg, type = 'success', timeout = 2600){
    popup.textContent = msg;
    popup.className = 'popup ' + (type === 'error' ? 'error' : 'success');
    popup.style.display = 'block';
    setTimeout(()=> popup.style.display = 'none', timeout);
  }

  let currentUser = null;

  // Load balance & user info
  async function loadBalance(){
    if(!currentUser) {
      balanceEl.textContent = '—';
      userEmailEl.textContent = 'Not logged in';
      return;
    }
    userEmailEl.textContent = currentUser.email || currentUser.phoneNumber || currentUser.uid;
    try {
      const snap = await db.ref(`users/${currentUser.uid}/balance`).once('value');
      const bal = parseFloat(snap.val()) || 0;
      balanceEl.textContent = bal.toLocaleString('en-US');
    } catch(err) {
      console.error('Load balance error', err);
      showPopup('Unable to load balance', 'error');
    }
  }

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(!user){
      showPopup('Please log in to withdraw', 'error', 2500);
      userEmailEl.textContent = 'Not logged in';
      balanceEl.textContent = '—';
      submitBtn.disabled = true;
    } else {
      submitBtn.disabled = false;
      loadBalance();
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if(!currentUser){ showPopup('Login required', 'error'); return; }

    const amount = Math.floor(parseFloat(amountInput.value || 0));
    if(!amount || amount < 1000){
      showPopup('Minimum withdrawal is 1,000 KES', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
<script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey:"AIzaSyCCW4G9JlVu_xb0bGjlKmsi5mdqXSwvFak",
    authDomain:"quantum-rio.firebaseapp.com",
    databaseURL:"https://quantum-rio-default-rtdb.firebaseio.com",
    projectId:"quantum-rio",
    storageBucket:"quantum-rio.appspot.com",
    messagingSenderId:"805433999377",
    appId:"1:805433999377:web:d0efa8c46ec4a0fa30f1b0",
    measurementId:"G-4RSQXZJX44"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- UI refs ----------
  const balanceEl = document.getElementById('balance');
  const userEmailEl = document.getElementById('userEmail');
  const form = document.getElementById('withdrawForm');
  const amountInput = document.getElementById('amount');
  const submitBtn = document.getElementById('submitBtn');
  const popup = document.getElementById('popup');

  function showPopup(msg, type = 'success', timeout = 2600){
    popup.textContent = msg;
    popup.className = 'popup ' + (type === 'error' ? 'error' : 'success');
    popup.style.display = 'block';
    setTimeout(()=> popup.style.display = 'none', timeout);
  }

  let currentUser = null;

  // Load balance & user info
  async function loadBalance(){
    if(!currentUser) {
      balanceEl.textContent = '—';
      userEmailEl.textContent = 'Not logged in';
      return;
    }
    userEmailEl.textContent = currentUser.email || currentUser.phoneNumber || currentUser.uid;
    try {
      const snap = await db.ref(`users/${currentUser.uid}/balance`).once('value');
      const bal = Number(snap.val()) || 0;
      balanceEl.textContent = bal.toLocaleString('en-US');
    } catch(err) {
      console.error('Load balance error', err);
      showPopup('Unable to load balance', 'error');
    }
  }

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(!user){
      showPopup('Please log in to withdraw', 'error', 2500);
      userEmailEl.textContent = 'Not logged in';
      balanceEl.textContent = '—';
      submitBtn.disabled = true;
    } else {
      submitBtn.disabled = false;
      loadBalance();
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if(!currentUser){ showPopup('Login required', 'error'); return; }

    const amount = Math.floor(Number(amountInput.value || 0));
    if(!amount || amount < 1000){
      showPopup('Minimum withdrawal is 1,000 KES', 'error');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    const balanceRef = db.ref(`users/${currentUser.uid}/balance`);

    balanceRef.transaction(function(currentBalance){
      let bal = Number(currentBalance);
      if (isNaN(bal)) bal = 0;   // ensure numeric

      if (bal >= amount) {
        return bal - amount;    // deduct
      } else {
        return currentBalance;  // return old balance → no change
      }
    }, async function(error, committed, snapshot){
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Withdrawal';

      if(error){
        console.error('Transaction failed:', error);
        showPopup('Error processing request', 'error');
        return;
      }

      if(!committed){
        showPopup('Insufficient balance', 'error');
        await loadBalance();
        return;
      }

      const newBalance = Number(snapshot.val()) || 0;

      try {
        const withdrawalRef = db.ref(`withdrawals/${currentUser.uid}`).push();
        await withdrawalRef.set({
          amount: amount,
          status: "submitted",
          timestamp: Date.now()
        });

        showPopup(`Withdrawal request submitted. KES ${amount.toLocaleString()} deducted.`, 'success');

        balanceEl.textContent = newBalance.toLocaleString('en-US');
        amountInput.value = '';
      } catch (err) {
        console.error('Failed to log withdrawal', err);
        showPopup('Withdrawal deducted but not logged. Contact support.', 'error', 4000);
        await loadBalance();
      }
    });
  });
</script>
</body>
</html>
